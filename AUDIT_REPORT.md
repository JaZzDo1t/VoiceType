# Аудит проекта VoiceType

**Дата аудита:** 2026-01-09
**Тип проекта:** Python desktop application (PyQt6 + Vosk + PyTorch)
**Размер:** 57 Python файлов, ~17,800 строк кода

---

## Резюме

| Категория | Статус | Оценка |
|-----------|--------|--------|
| **Архитектура** | Отлично | 9/10 |
| **Зависимости** | Хорошо | 8/10 |
| **Качество кода** | Хорошо | 7/10 |
| **Тестирование** | Хорошо | 8/10 |
| **Безопасность** | Хорошо | 8/10 |

**Общая оценка: 8/10** - Проект хорошо спроектирован, требует минимального рефакторинга.

---

## 1. Критичные проблемы (исправить сейчас)

### 1.1 Отсутствует numpy в requirements.txt

**Проблема:** Пакет `numpy` активно используется (`audio_capture.py`, тесты), но не указан явно в зависимостях. Сейчас работает как транзитивная зависимость от `torch`.

**Файлы:**
- `voicetype/src/core/audio_capture.py` - `import numpy as np`
- `voicetype/tests/conftest.py` - использует numpy для аудио fixtures

**Риск:** При обновлении torch зависимость может измениться, сломав проект.

**Решение:** Добавить в `requirements.txt`:
```
numpy>=1.20.0,<2.0.0
```

### 1.2 Мёртвый код в OutputManager

**Проблема:** 5 методов определены, но никогда не вызываются.

**Файл:** `voicetype/src/core/output_manager.py`

| Метод | Строка | Статус |
|-------|--------|--------|
| `output_to_keyboard_slow()` | 168 | Не используется |
| `output_to_clipboard_and_paste()` | 222 | Не используется |
| `set_typing_delay()` | 254 | Не используется |
| `clear_clipboard()` | 263 | Не используется |
| `get_clipboard()` | 277 | Не используется |

**Решение:** Удалить неиспользуемые методы или добавить их использование в конфигурацию.

---

## 2. Важные улучшения (запланировать)

### 2.1 Слишком свободные версии зависимостей

**Проблема:** Версии указаны как `>=X.Y.Z`, что позволяет установить несовместимые мажорные версии.

**Текущее состояние:**
```
torch>=2.0.0        # Может установить torch 3.0.0 (breaking)
PyQt6>=6.6.0        # Может установить PyQt7 (breaking)
```

**Решение:** Использовать верхние границы:
```
torch>=2.0.0,<3.0.0
PyQt6>=6.6.0,<7.0.0
PyYAML>=6.0.0,<7.0.0
pynput>=1.7.6,<2.0.0
loguru>=0.7.0,<1.0.0
```

### 2.2 Дублирование кода загрузки моделей

**Проблема:** Методы `_load_models_async()` и `_reload_vosk_only_async()` в `app.py` содержат ~85% идентичного кода.

**Файл:** `voicetype/src/app.py`
- Строки 210-264: `_load_models_async()`
- Строки 266-317: `_reload_vosk_only_async()`

**Решение:** Извлечь общую логику в приватный метод `_load_vosk_model()`.

### 2.3 Потокобезопасность синглтонов

**Проблема:** Синглтоны `get_config()`, `get_database()`, `get_models_manager()` не защищены от race condition при создании.

**Файлы:**
- `voicetype/src/data/config.py:179-184`
- `voicetype/src/data/database.py:286-291`
- `voicetype/src/data/models_manager.py:263-268`

**Текущий код:**
```python
def get_config() -> Config:
    global _config_instance
    if _config_instance is None:
        _config_instance = Config()  # Race condition!
    return _config_instance
```

**Решение:** Добавить блокировку:
```python
import threading
_lock = threading.Lock()

def get_config() -> Config:
    global _config_instance
    if _config_instance is None:
        with _lock:
            if _config_instance is None:
                _config_instance = Config()
    return _config_instance
```

**Примечание:** Риск низкий, т.к. инициализация происходит до запуска потоков.

### 2.4 Захардкоженные значения

**Проблема:** Некоторые конфигурационные значения захардкожены в коде.

| Файл | Строка | Значение | Рекомендация |
|------|--------|----------|--------------|
| `output_manager.py` | 27 | `0.01` (typing delay) | Вынести в `constants.py` |
| `hotkey_manager.py` | 14 | `0.3` (debounce) | Вынести в `constants.py` |
| `tab_main.py` | 57 | `250` (combo width) | Вынести в `constants.py` |

---

## 3. Рекомендации (при возможности)

### 3.1 Большие файлы (>500 строк)

| Файл | Строки | Рекомендация |
|------|--------|--------------|
| `punctuation.py` | 908 | Разделить на `silero_te_jit.py` + `punctuation.py` |
| `app.py` | 741 | Извлечь `ModelLoader` и `StatsCollector` классы |
| `themes.py` | 669 | Допустимо (в основном CSS) |
| `tab_history.py` | 529 | Допустимо (UI компоненты) |

### 3.2 Длинные функции (>50 строк)

| Файл | Функция | Строки | Рекомендация |
|------|---------|--------|--------------|
| `main.py` | `main()` | 99 | Разбить на `_init_app()`, `_run_event_loop()` |
| `audio_capture.py` | `start()` | 105 | Извлечь `_try_fallback_rates()` |
| `punctuation.py` | `load_model()` | 117 | Извлечь `_try_jit_model()`, `_try_package_model()` |

### 3.3 Организация тестов

**Проблема:** 4 тестовых файла >1000 строк.

**Рекомендация:** Разбить по тестируемым компонентам:
- `test_core_production.py` → `test_audio_capture.py`, `test_recognizer.py`, etc.
- `test_ui_production.py` → `test_main_window.py`, `test_tabs.py`, etc.

### 3.4 Файл в корне проекта

**Проблема:** `silero_te_jit.py` находится в корне `voicetype/`, хотя относится к моделям.

**Решение:** Переместить в `voicetype/src/core/silero_te_jit.py` или `voicetype/models/silero-te/`.

---

## 4. Здоровые части (не трогать)

### 4.1 Архитектура слоёв

```
ui/          ← (widgets, tabs, themes)
   ↑
app.py       ← (main controller)
   ↑         ↑
core/        ← (recognizer, audio, output, punctuation, hotkeys)
   ↑
data/        ← (config, database, models)
   ↑
utils/       ← (constants, logger, system_info, autostart)
```

- Нет циклических зависимостей
- Правильное направление зависимостей (ui → app → core → data → utils)
- Чёткое разделение ответственности

### 4.2 Потокобезопасность Qt

Отлично реализована коммуникация между потоками через сигналы:

```python
# Правильно: emit сигнал из фонового потока
self._partial_result_signal.emit(text)

# UI обновляется в главном потоке через слоты
```

### 4.3 Конфигурация

- `yaml.safe_load()` используется корректно (безопасность)
- Точечная нотация доступа: `config.get("audio.language")`
- Автосохранение при изменениях
- Слияние с дефолтами при загрузке

### 4.4 База данных

- Context manager для соединений: `with self._get_connection() as conn:`
- Потокобезопасные операции
- Ограничение истории (15 записей)
- Очистка старых статистик (24 часа)

### 4.5 Тестирование

- Маркеры: `@pytest.mark.hardware`, `@pytest.mark.slow`, `@pytest.mark.e2e`
- Автоскип при отсутствии моделей/оборудования
- Fixtures для сброса синглтонов
- Покрытие всех основных модулей

### 4.6 Обработка ошибок

- Graceful degradation (отключение пунктуации при отсутствии модели)
- Fallback sample rates в audio capture
- Логирование ошибок через loguru

---

## 5. Анализ зависимостей

### 5.1 Все зависимости используются

| Пакет | Назначение | Статус |
|-------|------------|--------|
| vosk | Распознавание речи | Используется |
| torch | ML для пунктуации | Используется |
| pyaudio | Захват аудио | Используется |
| PyQt6 | GUI | Используется |
| pynput | Эмуляция клавиатуры | Используется |
| pyperclip | Буфер обмена | Используется |
| psutil | Системная информация | Используется |
| PyYAML | Конфигурация | Используется |
| loguru | Логирование | Используется |

### 5.2 Нет дублирующих зависимостей

- Один HTTP клиент: нет (оффлайн приложение)
- Одна библиотека логирования: loguru
- Одна библиотека конфигурации: PyYAML
- Один UI фреймворк: PyQt6

### 5.3 Тяжёлые зависимости

**PyTorch (~2GB)**
- Необходим для Silero TE (пунктуация)
- Оптимизирован через TorchScript JIT
- Ленивая загрузка
- Альтернатив нет без потери функциональности

---

## 6. План рефакторинга

### Приоритет 1 (текущий спринт)

1. **Добавить numpy в requirements.txt** (5 мин)
   ```
   numpy>=1.20.0,<2.0.0
   ```

2. **Удалить мёртвый код из output_manager.py** (15 мин)
   - Удалить 5 неиспользуемых методов
   - Или документировать для будущего использования

3. **Ужесточить версии зависимостей** (10 мин)
   - Добавить верхние границы для критичных пакетов

### Приоритет 2 (следующий спринт)

4. **Извлечь общую логику загрузки моделей** (1-2 часа)
   - Создать `_load_vosk_model()` helper
   - Рефакторить `_load_models_async()` и `_reload_vosk_only_async()`

5. **Добавить потокобезопасность синглтонам** (30 мин)
   - Добавить `threading.Lock()` в get_config, get_database, get_models_manager

6. **Вынести захардкоженные значения в constants.py** (30 мин)

### Приоритет 3 (при возможности)

7. **Разбить punctuation.py** (2-3 часа)
8. **Реорганизовать тесты** (2 часа)
9. **Добавить type hints везде** (2 часа)
10. **Переместить silero_te_jit.py** (15 мин)

---

## 7. Метрики проекта

```
Файлов Python:      57
Строк кода:         17,810
Тестовых файлов:    12
Покрытие модулей:   100% (все модули имеют тесты)

Слои архитектуры:
├── utils/          4 файла, ~515 строк
├── data/           3 файла, ~761 строка
├── core/           5 файлов, ~2,272 строк
├── ui/             10 файлов, ~2,947 строк
└── app + main      2 файла, ~853 строки

Зависимости:
├── Production:     9 пакетов
└── Development:    8 пакетов
```

---

## Заключение

VoiceType - **хорошо спроектированный проект** с минимальным техническим долгом. Основные достоинства:

1. **Чистая архитектура** - правильное разделение слоёв без циклических зависимостей
2. **Потокобезопасность** - корректное использование Qt сигналов
3. **Качественное тестирование** - маркеры, fixtures, полное покрытие модулей
4. **Минимальные зависимости** - нет дублирования, все пакеты используются

Основные проблемы носят **косметический характер** и не влияют на работоспособность:
- Отсутствие явной зависимости numpy
- Мёртвый код в одном файле
- Слишком свободные версии зависимостей

**Рекомендация:** Выполнить задачи приоритета 1 перед релизом (30 минут работы).
